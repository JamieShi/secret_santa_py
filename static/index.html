<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Secret Santa æŠ½ç­¾</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        max-width: 480px;
        margin: 0 auto;
        padding: 16px;
        background: #f5f5f5;
      }

      h1 {
        font-size: 1.4rem;
        text-align: center;
        margin-bottom: 16px;
      }

      .card {
        background: #ffffff;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        margin-bottom: 16px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }

      select,
      button {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-size: 1rem;
        margin-bottom: 12px;
        box-sizing: border-box;
      }

      button {
        border: none;
        background: #0084ff;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      button:disabled {
        background: #b0b0b0;
        cursor: not-allowed;
      }

      .message {
        margin-top: 8px;
        font-size: 0.95rem;
      }

      .message.error {
        color: #d32f2f;
      }

      .message.success {
        color: #2e7d32;
      }

      .status-list {
        list-style: none;
        padding-left: 0;
        margin: 0;
      }

      .status-list li {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px solid #eee;
        font-size: 0.95rem;
      }

      .status-list li:last-child {
        border-bottom: none;
      }

      .status-tag {
        font-size: 0.85rem;
      }

      .done {
        color: #2e7d32;
      }

      .pending {
        color: #f57c00;
      }

      .hint {
        font-size: 0.85rem;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>Secret Santa æŠ½ç­¾</h1>

    <div class="card">
      <label for="nameSelect">1ï¸âƒ£ è¯·é€‰æ‹©ä½ çš„åå­—</label>
      <select id="nameSelect">
        <option value="">-- è¯·é€‰æ‹© --</option>
        <option value="Jamie">Jamie</option>
        <option value="Emily">Emily</option>
        <option value="Xiwei">Xiwei</option>
        <option value="Yujia">Yujia</option>
        <option value="Ruolan">Ruolan</option>
      </select>

      <button id="drawButton">2ï¸âƒ£ å¼€å§‹æŠ½ç­¾</button>

      <div id="result" class="message"></div>
      <div class="hint">
        âš ï¸ æŠ½ç­¾åªæœ‰ä¸€æ¬¡æœºä¼šï¼ŒæŠ½å®Œä¸èƒ½æ›´æ”¹ï¼Œè¯·ç¡®è®¤ä½ é€‰çš„æ˜¯è‡ªå·±çš„åå­—ã€‚
      </div>
    </div>

    <div class="card">
      <h2 style="font-size:1.1rem; margin-top:0;">å½“å‰æŠ½ç­¾è¿›åº¦</h2>
      <ul id="statusList" class="status-list"></ul>
      <div class="hint">å¤§å®¶éƒ½å¯ä»¥çœ‹åˆ°è°å·²ç»æŠ½ç­¾ï¼Œä½†çœ‹ä¸åˆ°æŠ½åˆ°è°ã€‚</div>
    </div>

    <script>
      const nameSelect = document.getElementById("nameSelect");
      const drawButton = document.getElementById("drawButton");
      const resultDiv = document.getElementById("result");
      const statusList = document.getElementById("statusList");

      async function fetchState() {
        try {
          const res = await fetch("/api/state");
          if (!res.ok) {
            throw new Error("æ— æ³•è·å–çŠ¶æ€");
          }
          const data = await res.json();
          renderStatus(data.participants || []);
        } catch (err) {
          console.error(err);
        }
      }

      function renderStatus(participants) {
        statusList.innerHTML = "";
        participants.forEach((p) => {
          const li = document.createElement("li");
          const nameSpan = document.createElement("span");
          nameSpan.textContent = p.name;

          const statusSpan = document.createElement("span");
          statusSpan.classList.add("status-tag");
          if (p.hasDrawn) {
            statusSpan.textContent = "âœ… å·²æŠ½";
            statusSpan.classList.add("done");
          } else {
            statusSpan.textContent = "â³ æœªæŠ½";
            statusSpan.classList.add("pending");
          }

          li.appendChild(nameSpan);
          li.appendChild(statusSpan);
          statusList.appendChild(li);
        });
      }

      async function drawSecretSanta() {
        const name = nameSelect.value;
        resultDiv.textContent = "";
        resultDiv.className = "message";

        if (!name) {
          resultDiv.textContent = "è¯·å…ˆé€‰æ‹©ä½ çš„åå­—ã€‚";
          resultDiv.classList.add("error");
          return;
        }

        drawButton.disabled = true;

        try {
          const res = await fetch("/api/draw", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name }),
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || "æŠ½ç­¾å¤±è´¥");
          }

          resultDiv.textContent = `ğŸ ä½ æŠ½åˆ°çš„æ˜¯ï¼š${data.recipient}ã€‚è¯·ä¿å¯†å“¦ï¼`;
          resultDiv.classList.add("success");

          // æŠ½ç­¾æˆåŠŸååˆ·æ–°çŠ¶æ€åˆ—è¡¨
          fetchState();
        } catch (err) {
          resultDiv.textContent = err.message;
          resultDiv.classList.add("error");

          // å¦‚æœä¸æ˜¯â€œå·²ç»æŠ½è¿‡äº†â€ï¼Œå…è®¸å†ç‚¹ä¸€æ¬¡
          if (!/å·²ç»æŠ½è¿‡/.test(err.message)) {
            drawButton.disabled = false;
          }
        }
      }

      drawButton.addEventListener("click", drawSecretSanta);

      // é¡µé¢åŠ è½½æ—¶è·å–ä¸€æ¬¡çŠ¶æ€
      fetchState();

      // æ¯ 10 ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€ï¼Œè®©è¿›åº¦æ›´å®æ—¶
      setInterval(fetchState, 10000);
    </script>
  </body>
</html>
